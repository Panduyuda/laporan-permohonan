<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sistem Laporan DLH Sukoharjo</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #f0fdf4;
    }
    .hijau-gelap {
      background-color: #1a5632;
    }
    .hijau-terang {
      background-color: #2e8540;
    }
    .border-hijau {
      border-color: #1a5632;
    }
    .btn-hijau {
      background: linear-gradient(to bottom, #2e8540, #1a5632);
    }
    .card-shadow {
      box-shadow: 0 4px 6px rgba(0, 100, 0, 0.1);
    }
    .logo-kiri {
      position: absolute;
      left: 20px;
      top: 10px;
    }
    .logo-kanan {
      position: absolute;
      right: 20px;
      top: 10px;
    }
    .header-content {
      position: relative;
      padding-top: 100px;
    }
    .title-main {
      font-size: 2.5rem;
      line-height: 1.2;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
    }
    .title-sub {
      font-size: 1.8rem;
      line-height: 1.3;
    }
    .title-system {
      font-size: 1.5rem;
      letter-spacing: 1px;
    }
    .action-btn {
      transition: all 0.2s ease;
    }
    .action-btn:hover {
      transform: scale(1.1);
    }
    .form-section {
      background-color: white;
      border-radius: 0.75rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .form-header {
      background-color: #2e8540;
      color: white;
      padding: 0.75rem 1.5rem;
      border-top-left-radius: 0.75rem;
      border-top-right-radius: 0.75rem;
    }
    .form-group {
      margin-bottom: 1rem;
    }
    .form-label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: #374151;
    }
    .form-input {
      width: 100%;
      padding: 0.5rem 1rem;
      border: 1px solid #d1d5db;
      border-radius: 0.375rem;
      background-color: #f9fafb;
    }
    .form-input:focus {
      outline: none;
      border-color: #2e8540;
      box-shadow: 0 0 0 3px rgba(46, 133, 64, 0.1);
    }
    @media (max-width: 640px) {
      .header-content {
        padding-top: 80px;
      }
      .logo-kiri, .logo-kanan {
        position: static;
        text-align: center;
        margin: 10px auto;
        display: block;
      }
      .title-main {
        font-size: 1.8rem;
      }
      .title-sub {
        font-size: 1.4rem;
      }
      .title-system {
        font-size: 1.2rem;
      }
    }
  </style>
</head>
<body>
  <!-- Header with Corner Logos -->
  <div class="hijau-gelap py-4 text-white relative min-h-[180px]">
    <!-- Logo Kabupaten (Pojok Kiri) -->
    <div class="logo-kiri">
      <img src="logo/PEMKAB-SUKOHARJO-01.png" alt="Logo Kabupaten" class="h-[150px] max-w-[150px] w-auto">
    </div>
    
    <!-- Logo Bidang (Pojok Kanan) -->
    <div class="logo-kanan">
      <img src="logo/Logo-01.png" alt="Logo Bidang" class="h-[150px] max-w-[150px] w-auto">
    </div>
    
    <!-- Judul Tengah -->
    <div class="header-content text-center mx-auto pt-2">
      <h1 class="title-main font-bold mb-2">DINAS LINGKUNGAN HIDUP</h1>
      <h2 class="title-sub font-semibold mb-3">KABUPATEN SUKOHARJO</h2>
      <p class="title-system font-medium italic">Sistem Laporan Permohonan Bantuan</p>
    </div>
  </div>

  <div class="container mx-auto p-4 md:p-6">
    <!-- Form Section - Updated to match your image layout -->
    <div class="form-section mb-8">
      <div class="form-header">
        <h2 class="text-xl font-bold">Laporan Permohonan Bantuan</h2>
      </div>
      
      <div class="p-6">
        <!-- Tanggal dan Nomor Surat -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
          <div class="form-group">
            <label for="tanggal" class="form-label">Tanggal</label>
            <input type="date" id="tanggal" class="form-input">
          </div>
          <div class="form-group">
            <label for="noSurat" class="form-label">Nomor Surat</label>
            <input type="text" id="noSurat" class="form-input" placeholder="Masukkan nomor surat">
          </div>
        </div>

        <!-- Pemohon dan Alamat -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
          <div class="form-group">
            <label for="pemohon" class="form-label">Nama Pemohon/Instansi</label>
            <input type="text" id="pemohon" class="form-input" placeholder="Nama lengkap pemohon">
          </div>
          <div class="form-group">
            <label for="alamat" class="form-label">Alamat</label>
            <input type="text" id="alamat" class="form-input" placeholder="Alamat lengkap">
          </div>
        </div>

        <!-- Keterangan Permohonan -->
        <div class="mb-6">
          <label class="form-label">Keterangan Permohonan</label>
          <div id="barangContainer" class="space-y-4">
            <!-- Barang akan ditambahkan dinamis di sini -->
          </div>
          <button type="button" onclick="tambahBarang()" class="mt-2 text-sm text-green-600 hover:text-green-800 flex items-center">
            <i class="fas fa-plus-circle mr-1"></i> Tambah Barang
          </button>
        </div>

        <!-- Status Realisasi -->
        <div class="mb-6">
          <label for="realisasi" class="form-label">Status Realisasi</label>
          <select id="realisasi" class="form-input">
            <option value="">Pilih status realisasi</option>
            <option value="Sudah">Sudah Direalisasi</option>
            <option value="Belum">Belum Direalisasi</option>
            <option value="TL">Tindak Lanjut</option>
          </select>
        </div>

        <!-- Submit Button -->
        <div class="flex justify-end">
          <button onclick="submitData()" class="btn-hijau text-white px-6 py-2 rounded-lg font-medium flex items-center">
            <i class="fas fa-paper-plane mr-2"></i> Kirim Permohonan
          </button>
        </div>
      </div>
    </div>

    <!-- Template untuk input barang (hidden) -->
    <template id="barangTemplate">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 barang-item p-4 bg-gray-50 rounded-lg">
        <div>
          <select class="form-input jenis-barang">
            <option value="">Pilih Jenis Barang</option>
            <option value="Komposter">Komposter</option>
            <option value="Tempat Sampah Pilah">Tempat Sampah Pilah</option>
            <option value="Gerobak Sampah">Gerobak Sampah</option>
            <option value="Mesin Pencacah">Mesin Pencacah</option>
            <option value="Motor Roda 3">Motor Roda 3</option>
            <option value="Timbangan">Timbangan</option>
            <option value="Lainnya">Lainnya</option>
          </select>
        </div>
        <div class="flex items-center">
          <input type="number" min="1" class="form-input jumlah-barang" placeholder="Jumlah">
          <button type="button" onclick="hapusBarang(this)" class="ml-2 text-red-500 hover:text-red-700">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="col-span-2 catatan-lainnya-container hidden">
          <input type="text" class="form-input catatan-lainnya" placeholder="Sebutkan jenis barang">
        </div>
      </div>
    </template>

    <!-- Search and Filter Section -->
    <div class="bg-white rounded-xl shadow-md overflow-hidden mb-6 p-4">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label for="searchInput" class="block text-sm font-medium text-gray-700 mb-1">Cari</label>
          <input type="text" id="searchInput" placeholder="Cari pemohon/alamat..." 
                 class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
        </div>
        <div>
          <label for="dateFrom" class="block text-sm font-medium text-gray-700 mb-1">Dari Tanggal</label>
          <input type="date" id="dateFrom" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
        </div>
        <div>
          <label for="dateTo" class="block text-sm font-medium text-gray-700 mb-1">Sampai Tanggal</label>
          <input type="date" id="dateTo" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
        </div>
      </div>
      <div class="mt-4 flex justify-between">
        <button onclick="resetFilters()" class="text-gray-600 hover:text-gray-800 flex items-center">
          <i class="fas fa-sync-alt mr-1"></i> Reset Filter
        </button>
        <button onclick="applyFilters()" class="btn-hijau text-white px-4 py-2 rounded-lg font-medium flex items-center">
          <i class="fas fa-filter mr-2"></i> Terapkan Filter
        </button>
      </div>
    </div>

    <!-- Statistik -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 my-8">
      <div class="stat-card bg-white rounded-xl shadow-md overflow-hidden border-l-4 border-green-500">
        <div class="p-6">
          <div class="flex items-center">
            <div class="p-3 rounded-full bg-green-100 text-green-600 mr-4">
              <i class="fas fa-file-alt text-lg"></i>
            </div>
            <div>
              <h3 class="text-lg font-semibold text-gray-700">Total Permohonan</h3>
              <p class="text-2xl font-bold text-gray-900" id="totalData">0</p>
            </div>
          </div>
        </div>
      </div>
      <div class="stat-card bg-white rounded-xl shadow-md overflow-hidden border-l-4 border-blue-500">
        <div class="p-6">
          <div class="flex items-center">
            <div class="p-3 rounded-full bg-blue-100 text-blue-600 mr-4">
              <i class="fas fa-check-circle text-lg"></i>
            </div>
            <div>
              <h3 class="text-lg font-semibold text-gray-700">Sudah Direalisasi</h3>
              <p class="text-2xl font-bold text-gray-900" id="sudahData">0</p>
            </div>
          </div>
        </div>
      </div>
      <div class="stat-card bg-white rounded-xl shadow-md overflow-hidden border-l-4 border-yellow-500">
        <div class="p-6">
          <div class="flex items-center">
            <div class="p-3 rounded-full bg-yellow-100 text-yellow-600 mr-4">
              <i class="fas fa-clock text-lg"></i>
            </div>
            <div>
              <h3 class="text-lg font-semibold text-gray-700">Belum Direalisasi</h3>
              <p class="text-2xl font-bold text-gray-900" id="belumData">0</p>
            </div>
          </div>
        </div>
      </div>
      <div class="stat-card bg-white rounded-xl shadow-md overflow-hidden border-l-4 border-red-500">
        <div class="p-6">
          <div class="flex items-center">
            <div class="p-3 rounded-full bg-red-100 text-red-600 mr-4">
              <i class="fas fa-times-circle text-lg"></i>
            </div>
            <div>
              <h3 class="text-lg font-semibold text-gray-700">Tindak Lanjut</h3>
              <p class="text-2xl font-bold text-gray-900" id="tlData">0</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Export Button -->
    <div class="flex justify-end mb-4">
      <button onclick="exportData()" class="bg-white border border-green-500 text-green-500 hover:bg-green-50 px-4 py-2 rounded-lg font-medium flex items-center">
        <i class="fas fa-file-export mr-2"></i> Export Data
      </button>
    </div>

    <!-- Tabel Data -->
    <div class="bg-white rounded-xl shadow-md overflow-hidden mb-8">
      <div class="bg-green-600 px-6 py-3 flex justify-between items-center">
        <h2 class="text-xl font-bold text-white flex items-center">
          <i class="fas fa-table mr-2"></i> Data Permohonan Bantuan
        </h2>
        <div class="text-white text-sm" id="dataCount">Menampilkan 0 data</div>
      </div>
      <div class="p-6">
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No Surat</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pemohon</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Alamat</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Keterangan</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Realisasi</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
              </tr>
            </thead>
            <tbody id="dataTable" class="bg-white divide-y divide-gray-200">
              <!-- Data will be inserted here -->
              <tr>
                <td colspan="7" class="px-6 py-4 text-center text-gray-500">
                  <div class="flex justify-center">
                    <i class="fas fa-spinner fa-spin text-2xl text-green-500"></i>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="mt-4 flex justify-between items-center">
          <div class="text-sm text-gray-500" id="paginationInfo"></div>
          <div class="flex space-x-2">
            <button id="prevPage" onclick="changePage(-1)" disabled class="px-3 py-1 border border-gray-300 rounded text-gray-500 bg-white disabled:opacity-50">
              <i class="fas fa-chevron-left"></i>
            </button>
            <button id="nextPage" onclick="changePage(1)" disabled class="px-3 py-1 border border-gray-300 rounded text-gray-500 bg-white disabled:opacity-50">
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Info Boxes -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
      <!-- Edukasi -->
      <div class="bg-white rounded-xl shadow-md overflow-hidden">
        <div class="bg-blue-600 px-6 py-3">
          <h2 class="text-xl font-bold text-white flex items-center">
            <i class="fas fa-tools mr-2"></i> Tips Pengelolaan Sarana Prasarana
          </h2>
        </div>
        <div class="p-6">
          <ul class="space-y-3">
            <li class="flex items-start">
              <i class="fas fa-calendar-check text-blue-500 mt-1 mr-3"></i>
              <span>Lakukan pemeliharaan rutin pada sarana dan prasarana yang ada</span>
            </li>
            <li class="flex items-start">
              <i class="fas fa-bolt text-blue-500 mt-1 mr-3"></i>
              <span>Optimalkan penggunaan fasilitas untuk efisiensi energi dan sumber daya</span>
            </li>
            <li class="flex items-start">
              <i class="fas fa-microchip text-blue-500 mt-1 mr-3"></i>
              <span>Manfaatkan teknologi terkini untuk meningkatkan kinerja sarana prasarana</span>
            </li>
            <li class="flex items-start">
              <i class="fas fa-clipboard-list text-blue-500 mt-1 mr-3"></i>
              <span>Lakukan inventarisasi berkala untuk mencatat kondisi aset</span>
            </li>
            <li class="flex items-start">
              <i class="fas fa-exclamation-triangle text-blue-500 mt-1 mr-3"></i>
              <span>Sediakan sistem pelaporan kerusakan untuk perbaikan cepat</span>
            </li>
          </ul>
        </div>
      </div>

      <!-- Kontak -->
      <div class="bg-white rounded-xl shadow-md overflow-hidden">
        <div class="bg-green-600 px-6 py-3">
          <h2 class="text-xl font-bold text-white flex items-center">
            <i class="fas fa-address-card mr-2"></i> Kontak Kami
          </h2>
        </div>
        <div class="p-6">
          <div class="flex items-start mb-4">
            <i class="fas fa-map-marker-alt text-green-500 mt-1 mr-4 text-lg"></i>
            <div>
              <h3 class="font-semibold text-gray-800">Alamat Kantor</h3>
              <p class="text-gray-600">Jl. Jend. Sudirman No.199, Sukoharjo, Jawa Tengah</p>
            </div>
          </div>
          <div class="flex items-start mb-4">
            <i class="fas fa-phone-alt text-green-500 mt-1 mr-4 text-lg"></i>
            <div>
              <h3 class="font-semibold text-gray-800">Telepon</h3>
              <p class="text-gray-600">(0271) 593067</p>
            </div>
          </div>
          <div class="flex items-start mb-4">
            <i class="fas fa-envelope text-green-500 mt-1 mr-4 text-lg"></i>
            <div>
              <h3 class="font-semibold text-gray-800">Email</h3>
              <p class="text-gray-600">dlh@sukoharjokab.go.id</p>
            </div>
          </div>
          <div class="flex items-start">
            <i class="fas fa-clock text-green-500 mt-1 mr-4 text-lg"></i>
            <div>
              <h3 class="font-semibold text-gray-800">Jam Operasional</h3>
              <p class="text-gray-600">Senin-Kamis: 07.00-15.30 WIB</p>
              <p class="text-gray-600">Jumat      : 07.00-14.00 WIB</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="bg-gray-800 text-white py-6">
    <div class="container mx-auto px-4">
      <div class="flex flex-col md:flex-row justify-between items-center">
        <div class="mb-4 md:mb-0">
          <p class="text-sm">Â© 2023 Dinas Lingkungan Hidup Kabupaten Sukoharjo</p>
          <p class="text-xs text-gray-400">Sistem Laporan Permohonan Bantuan Bank Sampah</p>
        </div>
        <div class="flex space-x-4">
          <a href="#" class="text-gray-300 hover:text-white">
            <i class="fab fa-facebook-f"></i>
          </a>
          <a href="#" class="text-gray-300 hover:text-white">
            <i class="fab fa-twitter"></i>
          </a>
          <a href="#" class="text-gray-300 hover:text-white">
            <i class="fab fa-instagram"></i>
          </a>
          <a href="#" class="text-gray-300 hover:text-white">
            <i class="fab fa-youtube"></i>
          </a>
        </div>
      </div>
    </div>
  </footer>

  <!-- Script -->
  <script>
    const url = "https://script.google.com/macros/s/AKfycbyNwmkIydxedMcOpymZzRvYWkeYLw0PNmpu4BbaQIzIDhOclJLW5vboWspQg-0O8Yaf/exec";
    let allData = [];
    let filteredData = [];
    let currentPage = 1;
    const itemsPerPage = 10;

    // Initialize the form with one item when page loads
    document.addEventListener('DOMContentLoaded', function() {
      tambahBarang();
      fetchData();
    });

    // Fungsi untuk menambah input barang
    function tambahBarang() {
      const template = document.getElementById('barangTemplate');
      const clone = template.content.cloneNode(true);
      document.getElementById('barangContainer').appendChild(clone);
      
      // Set event listener untuk select jenis barang
      const selectBarang = document.querySelector('#barangContainer .barang-item:last-child .jenis-barang');
      selectBarang.addEventListener('change', function() {
        const container = this.closest('.barang-item').querySelector('.catatan-lainnya-container');
        if (this.value === 'Lainnya') {
          container.classList.remove('hidden');
        } else {
          container.classList.add('hidden');
        }
      });
    }

    // Fungsi untuk menghapus input barang
    function hapusBarang(button) {
      const items = document.querySelectorAll('.barang-item');
      if (items.length > 1) {
        button.closest('.barang-item').remove();
      } else {
        alert('Minimal harus ada satu barang');
      }
    }

    // Format date to local Indonesian format
    function formatDate(dateString) {
      if (!dateString) return '-';
      const options = { day: '2-digit', month: '2-digit', year: 'numeric' };
      return new Date(dateString).toLocaleDateString('id-ID', options);
    }

    // Get status badge
    function getStatusBadge(status) {
      if (!status) return '<span class="px-2 py-1 text-xs rounded">-</span>';
      const lowerStatus = status.toLowerCase();
      if (lowerStatus === 'sudah') {
        return '<span class="px-2 py-1 text-xs font-semibold rounded bg-green-100 text-green-800">Sudah</span>';
      } else if (lowerStatus === 'belum') {
        return '<span class="px-2 py-1 text-xs font-semibold rounded bg-yellow-100 text-yellow-800">Belum</span>';
      } else if (lowerStatus === 'tl') {
        return '<span class="px-2 py-1 text-xs font-semibold rounded bg-red-100 text-red-800">TL</span>';
      }
      return status;
    }

    function submitData() {
      const tanggal = document.getElementById("tanggal");
      const noSurat = document.getElementById("noSurat");
      const pemohon = document.getElementById("pemohon");
      const alamat = document.getElementById("alamat");
      
      // Validation
      if (!tanggal.value || !noSurat.value || !pemohon.value || !alamat.value) {
        alert("Harap lengkapi semua data permohonan!");
        return;
      }

      // Collect item data
      const barangItems = document.querySelectorAll('.barang-item');
      const barangData = [];
      
      try {
        barangItems.forEach(item => {
          const jenis = item.querySelector('.jenis-barang').value;
          const jumlah = item.querySelector('.jumlah-barang').value;
          
          if (!jenis || !jumlah) {
            throw new Error("Harap lengkapi semua data barang!");
          }
          
          let keteranganBarang = jenis;
          if (jenis === 'Lainnya') {
            const catatan = item.querySelector('.catatan-lainnya').value;
            if (!catatan) {
              throw new Error("Harap isi keterangan untuk barang 'Lainnya'!");
            }
            keteranganBarang = catatan;
          }
          
          barangData.push({
            jenis: keteranganBarang,
            jumlah: parseInt(jumlah)
          });
        });

        const data = {
          action: "create",
          tanggal: tanggal.value,
          noSurat: noSurat.value,
          pemohon: pemohon.value,
          alamat: alamat.value,
          barang: JSON.stringify(barangData),
          keterangan: barangData.map(b => `${b.jenis} (${b.jumlah} buah)`).join(", "),
          realisasi: document.getElementById("realisasi").value || "Belum",
        };

        // Show loading state
        const button = document.querySelector('button[onclick="submitData()"]');
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Mengirim...';
        button.disabled = true;

        fetch(url, {
          method: "POST",
          body: JSON.stringify(data),
          headers: {
            'Content-Type': 'application/json'
          }
        })
        .then(res => {
          if (!res.ok) {
            throw new Error('Network response was not ok');
          }
          return res.text();
        })
        .then(responseText => {
          console.log('Response:', responseText);
          alert("Data berhasil dikirim!");
          fetchData();
          // Reset form
          document.getElementById("tanggal").value = "";
          document.getElementById("noSurat").value = "";
          document.getElementById("pemohon").value = "";
          document.getElementById("alamat").value = "";
          document.getElementById("realisasi").value = "";
          document.getElementById("barangContainer").innerHTML = "";
          tambahBarang(); // Add default item
        })
        .catch((error) => {
          console.error('Error:', error);
          alert(`Terjadi kesalahan: ${error.message}`);
        })
        .finally(() => {
          button.innerHTML = originalText;
          button.disabled = false;
        });
      } catch (error) {
        alert(error.message);
      }
    }

    // Fungsi untuk memperbarui status realisasi
    function updateRealisasi(id, status) {
      if (!confirm(`Apakah Anda yakin ingin mengubah status realisasi menjadi '${status}'?`)) {
        return;
      }

      const button = event.target.closest('button');
      const originalHTML = button.innerHTML;
      button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
      
      fetch(url, {
        method: "POST",
        body: JSON.stringify({
          action: "update",
          id: id,
          realisasi: status
        }),
        headers: {
          "Content-Type": "application/json"
        }
      })
      .then(res => res.text())
      .then(() => {
        alert("Status berhasil diperbarui!");
        fetchData(); // Memperbarui data setelah perubahan
      })
      .catch(() => {
        alert("Gagal memperbarui status.");
        button.innerHTML = originalHTML;
      });
    }

    // Fungsi untuk memuat data
    function fetchData() {
      fetch(url)
        .then(res => res.json())
        .then(data => {
          allData = data;
          filteredData = [...allData];
          updateStatistics();
          renderTable();
        })
        .catch(error => {
          console.error("Error fetching data:", error);
          const table = document.getElementById("dataTable");
          table.innerHTML = `
            <tr>
              <td colspan="7" class="px-6 py-4 text-center text-red-500">
                Gagal memuat data. Silakan coba lagi nanti.
              </td>
            </tr>
          `;
        });
    }

    // Fungsi untuk memperbarui statistik
    function updateStatistics() {
      let total = 0, sudah = 0, belum = 0, tl = 0;

      filteredData.forEach(item => {
        total++;
        if (item.realisasi) {
          if (item.realisasi.toLowerCase() === "sudah") sudah++;
          else if (item.realisasi.toLowerCase() === "belum") belum++;
          else if (item.realisasi.toLowerCase() === "tl") tl++;
        } else {
          belum++;
        }
      });

      document.getElementById("totalData").textContent = total;
      document.getElementById("sudahData").textContent = sudah;
      document.getElementById("belumData").textContent = belum;
      document.getElementById("tlData").textContent = tl;
      document.getElementById("dataCount").textContent = `Menampilkan ${filteredData.length} data`;
    }

    // Fungsi untuk merender tabel
    function renderTable() {
      const table = document.getElementById("dataTable");
      const startIndex = (currentPage - 1) * itemsPerPage;
      const paginatedData = filteredData.slice(startIndex, startIndex + itemsPerPage);

      // Clear existing data
      table.innerHTML = '';

      if (paginatedData.length === 0) {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td colspan="7" class="px-6 py-4 text-center text-gray-500">
            Tidak ada data yang ditemukan
          </td>
        `;
        table.appendChild(row);
      } else {
        paginatedData.forEach(item => {
          const row = document.createElement("tr");
          row.className = "hover:bg-gray-50";
          row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(item.tanggal)}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.noSurat || '-'}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.pemohon || '-'}</td>
            <td class="px-6 py-4 text-sm text-gray-500">${item.alamat || '-'}</td>
            <td class="px-6 py-4 text-sm text-gray-500">
              ${item.keterangan || '-'}
              ${item.barang ? '<div class="text-xs text-gray-400 mt-1">' + 
                 JSON.parse(item.barang).map(b => `${b.jenis}: ${b.jumlah}`).join(', ') + 
                 '</div>' : ''}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
              ${getStatusBadge(item.realisasi)}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
              <div class="flex space-x-2">
                <button onclick="updateRealisasi('${item.id}', 'Sudah')" 
                  class="action-btn text-green-600 hover:text-green-900" title="Sudah Direalisasi">
                  <i class="fas fa-check-circle"></i>
                </button>
                <button onclick="updateRealisasi('${item.id}', 'Belum')" 
                  class="action-btn text-yellow-600 hover:text-yellow-900" title="Belum Direalisasi">
                  <i class="fas fa-clock"></i>
                </button>
                <button onclick="updateRealisasi('${item.id}', 'TL')" 
                  class="action-btn text-red-600 hover:text-red-900" title="Tindak Lanjut">
                  <i class="fas fa-times-circle"></i>
                </button>
              </div>
            </td>
          `;
          table.appendChild(row);
        });
      }

      // Update pagination
      updatePagination();
    }

    // Fungsi untuk memperbarui tampilan pagination
    function updatePagination() {
      const totalPages = Math.ceil(filteredData.length / itemsPerPage);
      document.getElementById("prevPage").disabled = currentPage <= 1;
      document.getElementById("nextPage").disabled = currentPage >= totalPages;
      
      const paginationInfo = document.getElementById("paginationInfo");
      if (filteredData.length > 0) {
        const startItem = (currentPage - 1) * itemsPerPage + 1;
        const endItem = Math.min(currentPage * itemsPerPage, filteredData.length);
        paginationInfo.textContent = `Menampilkan ${startItem}-${endItem} dari ${filteredData.length} data`;
      } else {
        paginationInfo.textContent = "Tidak ada data";
      }
    }
    // Fungsi untuk mengganti halaman
    function changePage(direction) {
      const totalPages = Math.ceil(filteredData.length / itemsPerPage);
      const newPage = currentPage + direction;
      
      if (newPage > 0 && newPage <= totalPages) {
        currentPage = newPage;
        renderTable();
      }
    }

    // Fungsi untuk menerapkan filter
    function applyFilters() {
      const searchTerm = document.getElementById("searchInput").value.toLowerCase();
      const dateFrom = document.getElementById("dateFrom").value;
      const dateTo = document.getElementById("dateTo").value;
      
      filteredData = allData.filter(item => {
        // Filter pencarian
        const matchesSearch = !searchTerm || 
          (item.pemohon && item.pemohon.toLowerCase().includes(searchTerm)) || 
          (item.alamat && item.alamat.toLowerCase().includes(searchTerm));
        
        // Filter tanggal
        let matchesDate = true;
        if (dateFrom || dateTo) {
          const itemDate = new Date(item.tanggal);
          const fromDate = dateFrom ? new Date(dateFrom) : null;
          const toDate = dateTo ? new Date(dateTo) : null;
          
          if (fromDate && itemDate < fromDate) matchesDate = false;
          if (toDate && itemDate > toDate) matchesDate = false;
        }
        
        return matchesSearch && matchesDate;
      });

      currentPage = 1;
      renderTable();
    }

    // Fungsi untuk reset filter
    function resetFilters() {
      document.getElementById("searchInput").value = "";
      document.getElementById("dateFrom").value = "";
      document.getElementById("dateTo").value = "";
      filteredData = [...allData];
      currentPage = 1;
      renderTable();
    }

    // Fungsi untuk export data
    function exportData() {
      const dataStr = JSON.stringify(filteredData, null, 2);
      const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
      
      const exportFileDefaultName = 'data-permohonan.json';
      
      const linkElement = document.createElement('a');
      linkElement.setAttribute('href', dataUri);
      linkElement.setAttribute('download', exportFileDefaultName);
      linkElement.click();
    }
  </script>
</body>
</html>
